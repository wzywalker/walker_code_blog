<!DOCTYPE HTML>
<html lang="english">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="HandheldFriendly" content="true">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Maverick,AlanDecode,Galileo,blog" />
    <meta name="generator" content="Maverick 1.2.1" />
    <meta name="template" content="Prism" />
    <link rel="alternate" type="application/rss+xml" title="walker's code blog &raquo; RSS 2.0" href="/feed/index.xml" />
    <link rel="alternate" type="application/atom+xml" title="walker's code blog &raquo; ATOM 1.0" href="/feed/atom/index.xml" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/prism-b9d78ff38a.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/ExSearch/ExSearch-182e5a8869.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Code&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script>
        var ExSearchConfig = {
            root: "",
            api: "https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/a93aed159a38fa1e15f0447f262c225a.json"
        }

    </script>
    
<title>cs193p_2021笔记[6]_Persistence - walker's code blog</title>
<meta name="author" content="walker" />
<meta name="description" content="cs193p_2021_笔记_1" />
<meta property="og:title" content="cs193p_2021笔记[6]_Persistence - walker's code blog" />
<meta property="og:description" content="cs193p_2021_笔记_1" />
<meta property="og:site_name" content="walker's code blog" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/archives/cs193p_2021%E7%AC%94%E8%AE%B0%5B6%5D_Persistence/" />
<meta property="og:image" content="" />
<meta property="article:published_time" content="2021-10-24T05:00:00-00.00" />
<meta name="twitter:title" content="cs193p_2021笔记[6]_Persistence - walker's code blog" />
<meta name="twitter:description" content="cs193p_2021_笔记_1" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:image" content="" />


    
</head>

<body>
    <div class="container prism-container">
        <header class="prism-header" id="prism__header">
            <h1 class="text-uppercase brand"><a class="no-link" href="/" target="_self">walker's code blog</a></h1>
            <p>coder, reader</p>
            <nav class="prism-nav"><ul><li><a class="no-link text-uppercase " href="/" target="_self">Home</a></li><li><a class="no-link text-uppercase " href="/archives/" target="_self">Archives</a></li><li><a class="no-link text-uppercase " href="/about/" target="_self">About</a></li><li><a href="#" target="_self" class="search-form-input no-link text-uppercase">Search</a></li></ul></nav>
        </header>
        <div class="prism-wrapper" id="prism__wrapper">
            
<main>
    <section class="prism-section row" id="prism__content">
        <article class="yue col-md-8 offset-md-2">
            <h1 class="prism-post-title">cs193p_2021笔记[6]_Persistence</h1>
            <div class="prism-post-time">
                <time class="text-uppercase">
                    October 24 2021
                </time>
            </div>
            <div class="prism-content-body">
                <p><a href="https://www.jianshu.com/p/998b0ef4a2cd">cs193p_2021_笔记_1</a>
<a href="https://www.jianshu.com/p/af0ad1bead34">cs193p_2021_笔记_2</a>
<a href="https://www.jianshu.com/p/d103f8d12052">cs193p_2021_笔记_3_Animation_Transition</a>
<a href="https://www.jianshu.com/p/41e7309c7f55">cs193p_2021_笔记_4_Color_Image_Gesture</a>
<a href="https://www.jianshu.com/p/e3c2ee1628c6">cs193p_2021_笔记_5_Property Wrapper</a>
cs193p_2021_笔记_6_Persistence
<a href="https://www.jianshu.com/p/f4ae879eef9c">cs193p_2021_笔记_7_Document Architecture</a>
<a href="https://www.jianshu.com/p/2136bdc2c6f6">cs193p_2021_笔记_8</a></p><p>--</p><h1>Persistence</h1>
<p>持久化数据的方式有</p><ul>
<li>File system（FileManager）</li>
<li>Sqlite/CoreData</li>
<li>iCloud: 根据上面两种格式存储</li>
<li>CloutKit: a database in the cloud (network)</li>
<li>UserDefaults</li>
<li>Codable/JSON</li>
<li>UIDocument (UIKit feature)(与Files App集成)</li>
<li>3rd-party</li>
</ul>
<h2>UserDefaults</h2>
<ul>
<li>只能存储<code>Property List</code></li>
<li><code>Property List</code>支持String, Int, Bool, floating point, Date, Data, Array or Dictionary<ul>
<li>任何其它类型需要转成<code>Property List</code></li>
<li><code>Codable</code> converts structs into <code>Data</code> objects (and <code>Data</code> is a <code>Property List</code>).</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">defaults</span> <span class="p">=</span> <span class="n">UserDefaults</span><span class="p">.</span><span class="n">standard</span>
<span class="n">defaults</span><span class="p">.</span><span class="kr">set</span><span class="p">(</span><span class="n">object</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">SomeKey</span><span class="err">”</span><span class="p">)</span> <span class="c1">// object must be a Property List</span>
<span class="n">defaults</span><span class="p">.</span><span class="n">setDouble</span><span class="p">(</span><span class="mf">37.5</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyDouble</span><span class="err">”</span><span class="p">)</span>

<span class="c1">// retrive</span>

<span class="kd">let</span> <span class="nv">i</span><span class="p">:</span> <span class="nb">Int</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">integer</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyInteger</span><span class="err">”</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">b</span><span class="p">:</span> <span class="n">Data</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyData</span><span class="err">”</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">u</span><span class="p">:</span> <span class="n">URL</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyURL</span><span class="err">”</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">strings</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">]</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">stringArray</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyString</span><span class="err">”</span><span class="p">)</span> 
<span class="c1">// etc.</span>
<span class="c1">// Retrieving Arrays of anything but String is more complicated ...</span>
<span class="kd">let</span> <span class="nv">a</span> <span class="p">=</span> <span class="n">defaults</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">forKey</span><span class="p">:</span> <span class="err">“</span><span class="n">MyArray</span><span class="err">”</span><span class="p">)</span> <span class="c1">// will return Array&lt;Any&gt;</span>
<span class="c1">// 最好用Codable的data(forKey:)替代</span>
</pre></div>
<h2>Core Data</h2>
<p>SwiftUI进行的集成:</p><ul>
<li>创建的对象是<code>ObservableObjects</code></li>
<li>一个property wrapper <code>@FetchRequest</code></li>
<li>管理对象(context)是<code>NSManagedObjectContext</code></li>
<li>context通过<code>@Environment</code>传入</li>
</ul>
<p>demo:</p><div class="highlight"><pre><span></span><span class="p">@</span><span class="n">Environnment</span><span class="p">(</span><span class="err">\</span><span class="p">.</span><span class="n">managedObjectContext</span><span class="p">)</span> <span class="kd">var</span> <span class="nv">context</span>
<span class="kd">let</span> <span class="nv">flight</span> <span class="p">=</span> <span class="n">Flight</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
<span class="n">flight</span><span class="p">.</span><span class="n">aircraft</span> <span class="p">=</span> <span class="err">“</span><span class="n">B737</span><span class="err">”</span> <span class="c1">// etc.</span>

<span class="kd">let</span> <span class="nv">ksjc</span> <span class="p">=</span> <span class="n">Airport</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">context</span><span class="p">)</span>
<span class="n">ksjc</span><span class="p">.</span><span class="n">icao</span> <span class="p">=</span> <span class="err">“</span><span class="n">KSJC</span><span class="err">”</span> <span class="c1">// etc.</span>

<span class="n">flight</span><span class="p">.</span><span class="n">origin</span> <span class="p">=</span> <span class="n">ksjc</span> <span class="c1">// this would add flight to ksjc.flightsFrom too try? context.save()</span>

<span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="bp">NSFetchRequest</span><span class="p">&lt;</span><span class="n">Flight</span><span class="p">&gt;(</span><span class="n">entityName</span><span class="p">:</span> <span class="err">“</span><span class="n">Flight</span><span class="err">”</span><span class="p">)</span> <span class="n">request</span><span class="p">.</span><span class="n">predicate</span> <span class="p">=</span>
<span class="bp">NSPredicate</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="err">“</span><span class="n">arrival</span> <span class="o">&lt;</span> <span class="o">%</span><span class="p">@</span> <span class="n">and</span> <span class="n">origin</span> <span class="p">=</span> <span class="o">%</span><span class="p">@</span><span class="err">“</span><span class="p">,</span> <span class="n">Date</span><span class="p">(),</span> <span class="n">ksjc</span><span class="p">)</span> 
<span class="n">request</span><span class="p">.</span><span class="n">sortDescriptors</span> <span class="p">=</span> <span class="p">[</span><span class="bp">NSSortDescriptor</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="err">“</span><span class="n">ident</span><span class="err">”</span><span class="p">,</span> <span class="n">ascending</span><span class="p">:</span> <span class="kc">true</span><span class="p">)]</span> 

<span class="kd">let</span> <span class="nv">flights</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">context</span><span class="p">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="c1">// past KSJC flights sorted by ident</span>
<span class="c1">// flights is nil if fetch failed, [] if no such flights, otherwise [Flight]</span>
</pre></div>
<p>以上是core data部分，还是浓浓的OC的痕迹，看看Swift UI的版本。</p><p>首先，上述的<code>Flights, Airports</code>都是ViewModel。它自然拥有它的<code>Property Wrapper</code>:</p><div class="highlight"><pre><span></span><span class="p">@</span><span class="n">FetchRequest</span><span class="p">(</span><span class="n">entity</span><span class="p">:</span><span class="n">sortDescriptors</span><span class="p">:</span><span class="n">predicate</span><span class="p">:)</span> <span class="kd">var</span> <span class="nv">flights</span><span class="p">:</span> <span class="n">FetchedResults</span><span class="p">&lt;</span><span class="n">Flight</span><span class="p">&gt;</span>
<span class="p">@</span><span class="n">FetchRequest</span><span class="p">(</span><span class="n">fetchRequest</span><span class="p">:)</span> <span class="kd">var</span> <span class="nv">airports</span><span class="p">:</span> <span class="n">FetchedResults</span><span class="p">&lt;</span><span class="n">Airport</span><span class="p">&gt;</span>

<span class="c1">// flights and airports will continuously update as the database changes. </span>
<span class="n">ForEach</span><span class="p">(</span><span class="n">flights</span><span class="p">)</span> <span class="p">{</span> <span class="n">flight</span> <span class="k">in</span>
    <span class="c1">// UI for a flight built using flight </span>
<span class="p">}</span>

<span class="c1">// bi-binding</span>
<span class="n">_flights</span> <span class="p">=</span> <span class="n">FetchRequest</span><span class="p">(...)</span>
</pre></div>
<h2>Cloud Kit</h2>
<p>上个demo吧</p><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">db</span> <span class="p">=</span> <span class="bp">CKContainer</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="kd">public</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">privateCloudDatabase</span> 
<span class="c1">// Record理解为Table</span>
<span class="kd">let</span> <span class="nv">tweet</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="err">“</span><span class="n">Tweet</span><span class="err">”</span><span class="p">)</span>
<span class="c1">// 索引理解为Field</span>
<span class="n">tweet</span><span class="p">[</span><span class="err">“</span><span class="n">text</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="err">“</span><span class="mi">140</span> <span class="n">characters</span> <span class="n">of</span> <span class="n">pure</span> <span class="n">joy</span><span class="err">”</span>
<span class="kd">let</span> <span class="nv">tweeter</span> <span class="p">=</span> <span class="bp">CKRecord</span><span class="p">(</span><span class="err">“</span><span class="n">TwitterUser</span><span class="err">”</span><span class="p">)</span>
<span class="n">tweet</span><span class="p">[</span><span class="err">“</span><span class="n">tweeter</span><span class="err">”</span><span class="p">]</span> <span class="p">=</span> <span class="bp">CKReference</span><span class="p">(</span><span class="n">record</span><span class="p">:</span> <span class="n">tweeter</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="p">.</span><span class="n">deleteSelf</span><span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">tweet</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">savedRecord</span><span class="p">:</span> <span class="bp">CKRecord</span><span class="p">?,</span> <span class="n">error</span><span class="p">:</span> <span class="bp">NSError</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="nb">Void</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// hooray!</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">error</span><span class="p">?.</span><span class="n">errorCode</span> <span class="p">==</span> <span class="n">CKErrorCode</span><span class="p">.</span> <span class="n">NotAuthenticated</span><span class="p">.</span><span class="n">rawValue</span> <span class="p">{</span>
        <span class="c1">// tell user he or she has to be logged in to iCloud for this to work!</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// report other errors (there are 29 different CKErrorCodes!) </span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Query</span>
<span class="c1">// 类似core data, 构造predict, request(就是query)即可</span>

<span class="kd">let</span> <span class="nv">predicate</span> <span class="p">=</span> <span class="bp">NSPredicate</span><span class="p">(</span><span class="n">format</span><span class="p">:</span> <span class="err">“</span><span class="n">text</span> <span class="bp">contains</span> <span class="o">%</span><span class="p">@</span><span class="err">“</span><span class="p">,</span> <span class="n">searchString</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">query</span> <span class="p">=</span> <span class="bp">CKQuery</span><span class="p">(</span><span class="n">recordType</span><span class="p">:</span> <span class="err">“</span><span class="n">Tweet</span><span class="err">”</span><span class="p">,</span> <span class="n">predicate</span><span class="p">:</span> <span class="n">predicate</span><span class="p">)</span>
<span class="n">db</span><span class="p">.</span><span class="n">perform</span><span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">records</span><span class="p">:</span> <span class="p">[</span><span class="bp">CKRecord</span><span class="p">]?,</span> <span class="n">error</span><span class="p">:</span> <span class="bp">NSError</span><span class="p">?)</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">error</span> <span class="p">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// records will be an array of matching CKRecords</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">error</span><span class="p">?.</span><span class="n">errorCode</span> <span class="p">==</span> <span class="n">CKErrorCode</span><span class="p">.</span><span class="n">NotAuthenticated</span><span class="p">.</span><span class="n">rawValue</span> <span class="p">{</span>
        <span class="c1">// tell user he or she has to be logged in to iCloud for this to work!</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// report other errors (there are 29 different CKErrorCodes!) </span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>One of the coolest features of Cloud Kit is its ability to <code>send push notifications</code> on changes. All you do is register an <code>NSPredicate</code> and whenever the database changes to match it,</p><h2>File System</h2>
<p>Sandbox包含：</p><ul>
<li>Application directory — Your executable, .jpgs, etc.; not writeable.</li>
<li>Documents directory — Permanent storage created by and always visible to the user.</li>
<li>Application Support directory — Permanent storage not seen directly by the user.</li>
<li>Caches directory — Store temporary files here (this is not backed up).</li>
<li>Other directories (see documentation)</li>
<li>...</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">url</span><span class="p">:</span> <span class="n">URL</span> <span class="p">=</span> <span class="n">FileManager</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="n">url</span><span class="p">(</span>
    <span class="k">for</span> <span class="n">directory</span><span class="p">:</span> <span class="n">FileManager</span><span class="p">.</span><span class="n">SearchPathDirectory</span><span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span> <span class="c1">// for example </span>
    <span class="k">in</span> <span class="n">domainMask</span><span class="p">:</span> <span class="p">.</span><span class="n">userDomainMask</span> <span class="c1">// always .userDomainMask on iOS</span>
    <span class="n">appropriateFor</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="c1">// only meaningful for “replace” file operations</span>
    <span class="n">create</span><span class="p">:</span> <span class="kc">true</span> <span class="c1">// whether to create the system directory if it doesn’t already exist</span>
 <span class="p">)</span>
</pre></div>
<p>Examples of SearchPathDirectory values :</p><div class="highlight"><pre><span></span><span class="p">.</span><span class="n">documentDirectory</span><span class="p">,</span> 
<span class="p">.</span><span class="n">applicationSupportDirectory</span><span class="p">,</span> 
<span class="p">.</span><span class="n">cachesDirectory</span><span class="p">,</span> 
<span class="n">etc</span><span class="p">.</span>
</pre></div>
<p>再列些常用api：</p><div class="highlight"><pre><span></span><span class="c1">// URL</span>

<span class="kd">func</span> <span class="nf">appendingPathComponent</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">URL</span>
<span class="kd">func</span> <span class="nf">appendingPathExtension</span><span class="p">(</span><span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">URL</span> <span class="c1">// e.g. “jpg”</span>
<span class="kd">var</span> <span class="nv">isFileURL</span><span class="p">:</span> <span class="nb">Bool</span> <span class="c1">// is this a file URL (whether file exists or not) or something else? </span>
<span class="kd">func</span> <span class="nf">resourceValues</span><span class="p">(</span><span class="k">for</span> <span class="n">keys</span><span class="p">:</span> <span class="p">[</span><span class="n">URLResourceKey</span><span class="p">])</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="p">[</span><span class="n">URLResourceKey</span><span class="p">:</span><span class="nb">Any</span><span class="p">]?</span> 
<span class="c1">// Example keys: .creationDateKey, .isDirectoryKey, .fileSizeKey</span>

<span class="c1">// Data</span>

<span class="c1">// retrive binary data</span>
<span class="c1">// option almost always []</span>
<span class="kd">init</span><span class="p">(</span><span class="n">contentsOf</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Data</span><span class="p">.</span><span class="n">ReadingOptions</span><span class="p">)</span> <span class="kr">throws</span> 
<span class="c1">// write</span>
<span class="c1">// The options can be things like .atomic (write to tmp file, then swap) or .withoutOverwriting.</span>
<span class="kd">func</span> <span class="nf">write</span><span class="p">(</span><span class="n">to</span> <span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">options</span><span class="p">:</span> <span class="n">Data</span><span class="p">.</span><span class="n">WritingOptions</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>

<span class="c1">// FileManager</span>
<span class="n">fileExists</span><span class="p">(</span><span class="n">atPath</span><span class="p">:</span> <span class="nb">String</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span>
<span class="c1">// Can also create and enumerate directories; move, copy, delete files; etc.</span>
</pre></div>
<h2>Codable</h2>
<ul>
<li>保留一个对象所有的var（变量）的机制</li>
<li>如果一个Struct它的成员变是Codable的，那么Swift会帮你把这个Struct实现Codable，比如没有associated data的Enum。</li>
<li>帮你实现不代表不要显式声明</li>
<li>基础类型基本上都实现了Codable</li>
</ul>
<div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">object</span><span class="p">:</span> <span class="n">MyType</span> <span class="p">=</span> <span class="p">...</span>
<span class="c1">// encode</span>
<span class="kd">let</span> <span class="nv">jsonData</span><span class="p">:</span> <span class="n">Data</span><span class="p">?</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">JSONEncoder</span><span class="p">().</span><span class="n">encode</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>

<span class="c1">// write file</span>
<span class="k">try</span> <span class="n">jsonData</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">to</span><span class="p">:</span> <span class="n">url</span><span class="p">)</span>

<span class="c1">// deocde as string</span>
<span class="kd">let</span> <span class="nv">jsonString</span> <span class="p">=</span> <span class="nb">String</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">jsonData</span><span class="p">!,</span> <span class="n">encoding</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span>

<span class="c1">// decode as object</span>
<span class="kd">let</span> <span class="nv">myObject</span><span class="p">:</span> <span class="n">MyType</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">JSONDecoder</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="n">MyType</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">jsonData</span><span class="p">!)</span>
<span class="c1">// 从字符串到对象没有一步到位的办法，只能先string-&gt;Data</span>
<span class="kd">let</span> <span class="nv">data</span> <span class="p">=</span> <span class="n">jsstring</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span> <span class="c1">// 再把data传到上术方法里</span>
</pre></div>
<p>encode, decode是会throw的，注意try_catch相应的Error，比如<code>.keyNotFound, .dataCorrupted...</code></p><h3>CodingKeys</h3>
<p>json与对象相互进行转化有一个通用的需求，就是键的映射，这更常用在外部API与本地类的映射中，比如userId，别人叫guestId，等等，Swift中，用一个叫<code>CodingKeys</code>的枚举来实现这个映射：</p><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kd">enum</span> <span class="nc">CodingKeys</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">CodingKey</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">uid</span> <span class="p">=</span> <span class="s">&quot;user_id&quot;</span>
    <span class="k">case</span> <span class="n">someDate</span> <span class="p">=</span> <span class="s">&quot;some_date&quot;</span>
    <span class="k">case</span> <span class="n">pname</span> <span class="p">=</span> <span class="s">&quot;panme&quot;</span> <span class="c1">// 表示在JSON中也叫这个名字 </span>
    <span class="k">case</span> <span class="n">sku</span> <span class="c1">// 如果名字一样的话，可以这么简写 </span>
    <span class="c1">// 但是不写的话，序列化的时候就不会序列这个字段了</span>
    <span class="c1">// 解码时会有 KeyNotFound 类的错误</span>
<span class="p">}</span>

<span class="c1">// 结合起来，用在init中</span>
<span class="kd">init</span><span class="p">(</span><span class="n">from</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
    <span class="c1">// container是切入点，要弄清楚</span>
    <span class="c1">// 如果没有手写键的映射表，那么keydBy就是自己</span>
    <span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="p">.</span><span class="n">container</span><span class="p">(</span><span class="n">keyedBy</span><span class="p">:</span> <span class="n">CodingKeys</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
    <span class="n">someDate</span> <span class="p">=</span> <span class="k">try</span> <span class="n">container</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">Date</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">someDate</span><span class="p">)</span> 
    <span class="c1">// 从json中加载.someDate对应的键的值，尝试解码成Date</span>
    <span class="c1">// other vars (每种case必须全部都有)</span>
<span class="p">}</span>
</pre></div>
<h3>Enum</h3>
<p>序列化枚举有点复杂：</p><ol>
<li>简单枚举应该怎么序列化？ 其实是序列化成case对应的名字和表示空JSON的<code>{}</code>组成的键值对，比如<code>{&quot;math&quot;:{}}</code></li>
<li>有关联数据的枚举呢？ 那就得自己提供<code>encoder</code>:<ul>
<li><code>case url: try container.encode(url, forKey: .url)</code> 即对相应的枚举值进行相应的encode</li>
</ul>
</li>
<li>并且自行decode，但是与struct（为每一个key填值）不同，因为枚举变量只是一个值，所以是依次尝试，解码成功就认定是那一个枚举值</li>
</ol>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">container</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="n">URL</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">...</span> <span class="c1">// 别的尝试</span>

<span class="c1">// 此句的作用是根据.url对应的键名，取出值，反射成URL对象，如果成功，那么这个枚举值是.url无疑</span>
<span class="c1">// 而且关联数据就是反射的结果</span>
<span class="c1">// 如果失败，继续换一个键名，将对应的值转成对应的类型，依次类推</span>
</pre></div>
<ol start="4">
<li>那么如何手动decode一个原始的枚举呢？<ul>
<li>我们知道上述实践是为了反射出关联数据，并且根据能够成功反射关联数据来判断枚举类型</li>
<li>原始枚举需要encode哪个值呢？-&gt; 目前我只能做一个空<code>struct</code>来实现序列化成<code>{}</code>的目的 -&gt; 为了跟默认形态保持一致<ul>
<li>事实上你是可以encode成任意值的（比如100，&quot;hello&quot;，因为我们只关心有没有这个键，有的话，就是这个枚举类型，只是<code>{}</code>拥有可读性</li>
<li>你encode成什么值，decode的时候对对应的键尝试去反射回这个值就行了</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>最后，思考题：</p><blockquote>
<p>上面说了，原生枚举序列化成： <code>{&quot;math&quot;:{}}</code>，也说了，如果，键对应的值对原生枚举序列化是没意义的，可以是任何值，那么对于<code>{&quot;math&quot;:100}</code>，能否顺序序列化回其枚举形态<code>.math</code>呢？</p></blockquote>
<p>答案：</p><ol>
<li>值为100报错了</li>
<li>于是我改为&quot;&quot;或&quot;other“等字符串或空字符串，解码的结果是<code>nil</code></li>
</ol>
<p>也就是说，默认的decode只认<code>{}</code></p><figure  style="flex: 82.77310924369748" ><img width="1182" height="714" src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/archives/assets/c3a4240a7582937166f9300c35b4e868.png" alt=""/></figure><p>而前面我们知道了，如果是自己手写，它可以是任何值，它的意义仅仅是个标识，并不会取它的值。验证：</p><div class="highlight"><pre><span></span><span class="kd">enum</span> <span class="nc">NormEnum</span><span class="p">:</span> <span class="n">Codable</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">history</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">geometry</span>

    <span class="kd">private</span> <span class="kd">enum</span> <span class="nc">keyMap</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="n">CodingKey</span><span class="p">{</span>
        <span class="k">case</span> <span class="n">history</span>  <span class="p">=</span> <span class="s">&quot;HIST&quot;</span>
        <span class="k">case</span> <span class="n">math</span>     <span class="p">=</span> <span class="s">&quot;MATH&quot;</span>
        <span class="k">case</span> <span class="n">geometry</span> <span class="p">=</span> <span class="s">&quot;GEOM&quot;</span>
    <span class="p">}</span>

    <span class="kd">func</span> <span class="nf">encode</span><span class="p">(</span><span class="n">to</span> <span class="n">encoder</span><span class="p">:</span> <span class="n">Encoder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nv">container</span> <span class="p">=</span> <span class="k">try</span> <span class="n">encoder</span><span class="p">.</span><span class="n">container</span><span class="p">(</span><span class="n">keyedBy</span><span class="p">:</span> <span class="n">keyMap</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
        <span class="k">switch</span> <span class="kc">self</span><span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">history</span><span class="p">:</span> <span class="k">try</span> <span class="n">container</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">history</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">math</span><span class="p">:</span> <span class="k">try</span> <span class="n">container</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">math</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">geometry</span><span class="p">:</span> <span class="k">try</span> <span class="n">container</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">geometry</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">init</span><span class="p">(</span><span class="n">from</span> <span class="n">decoder</span><span class="p">:</span> <span class="n">Decoder</span><span class="p">)</span> <span class="kr">throws</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nv">container</span> <span class="p">=</span> <span class="k">try</span> <span class="n">decoder</span><span class="p">.</span><span class="n">container</span><span class="p">(</span><span class="n">keyedBy</span><span class="p">:</span> <span class="n">keyMap</span><span class="p">.</span><span class="kc">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="kd">let</span> <span class="nv">s</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">container</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">history</span><span class="p">)</span> <span class="p">{</span>
            <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">history</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="kd">let</span> <span class="nv">s</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">container</span><span class="p">.</span><span class="n">decode</span><span class="p">(</span><span class="nb">String</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">forKey</span><span class="p">:</span> <span class="p">.</span><span class="n">math</span><span class="p">)</span> <span class="p">{</span>
            <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">math</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kc">self</span> <span class="p">=</span> <span class="p">.</span><span class="n">geometry</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>上面的代码中，我将三个字段全部用空字符串编码，并且给了三个不同的键名，现在，我真入任意值，比如<code>&quot;HAHA&quot;</code>，解码看看：</p><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">js2</span> <span class="p">=</span> <span class="s">&quot;{</span><span class="se">\&quot;</span><span class="s">MATH</span><span class="se">\&quot;</span><span class="s">:</span><span class="se">\&quot;</span><span class="s">HAHA</span><span class="se">\&quot;</span><span class="s">}&quot;</span>
<span class="kd">let</span> <span class="nv">js2d</span> <span class="p">=</span> <span class="n">js2</span><span class="p">.</span><span class="n">data</span><span class="p">(</span><span class="n">using</span><span class="p">:</span> <span class="p">.</span><span class="n">utf8</span><span class="p">)</span>
<span class="kd">let</span> <span class="nv">myobj2</span> <span class="p">=</span> <span class="k">try</span><span class="p">?</span> <span class="n">JSONDecoder</span><span class="p">().</span><span class="n">decode</span><span class="p">(</span><span class="n">NormEnum</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="n">from</span><span class="p">:</span> <span class="n">js2d</span><span class="p">!)</span>
</pre></div>
<p>结果成功认出myobj2是一个<code>.math</code>。原理当然是我的代码里在尝试转成一个字符串，而没有限定是什么字符串。</p>
            </div>
        </article>
        <div class="prism-post-meta col-md-8 offset-md-2">
    <span>walker</span>
    
    <span>/</span>
    <span>
        <a class="category no-link" href="/category/posts/" target="_self">
        posts
        </a>
    </span>
    
    
    <span>/</span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/cs193p/" target="_self">#cs193p</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/userdefaults/" target="_self">#userdefaults</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/core%20data/" target="_self">#core data</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/codable/" target="_self">#codable</a>
    </span>
    
    <span class="prism-tag">
        <a class="no-link" href="/tag/cloudkit/" target="_self">#cloudkit</a>
    </span>
    
    
    
    <span>/</span>
    <span class="leancloud_visitors" id="/archives/cs193p_2021%E7%AC%94%E8%AE%B0%5B6%5D_Persistence/" data-flag-title="cs193p_2021笔记[6]_Persistence"><span class="leancloud-visitors-count"></span> Views</span>
    
</div>
    </section>

    
<section id="prism__pagination" class="prism-pagination" class="col-md-8 offset-md-2">
    <ul>
        
        <li class="next">
            <a class="no-link" href="/archives/cs193p_2021%E7%AC%94%E8%AE%B0%5B7%5D_Document-Architecture/" target="_self" title="cs193p_2021笔记[7]_Document-Architecture"><i class="fa fa-chevron-left" aria-hidden="true"></i>Newer</a>
        </li>
        
        
        <li class="prev">
            <a class="no-link" href="/archives/cs193p_2021%E7%AC%94%E8%AE%B0%5B5%5D_Property-Wrapper/" target="_self" title="cs193p_2021笔记[5]_Property-Wrapper">Older<i class="fa fa-chevron-right" aria-hidden="true"></i></a>
        </li>
        
    </ul>
</section>


    
    <script>
        var initValine = function() {
            new Valine({"enable": true, "el": "#vcomments", "appId": "7tP92LoqK2cggW61DvJmWBo0-gzGzoHsz", "appKey": "iQCtrtlr8eKrQllM03GMESMJ", "visitor": true, "recordIP": true});
        }

    </script>
    <script defer src='https://cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js' onload="initValine()"></script>
    <div class="prism-comment-section container" id="prism__comment">
        <div class="row">
            <div class="col-md-8 offset-md-2">
                <div id="vcomments"></div>
            </div>
        </div>
    </div>
    

</main>

            <footer id="prism__footer">
                <section>
                    <div>
                        <nav class="social-links">
                            <ul><li><a class="no-link" title="Twitter" href="https://twitter.com/walkerwzy" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-twitter"></i></a></li><li><a class="no-link" title="GitHub" href="https://github.com/walkerwzy" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-github"></i></a></li><li><a class="no-link" title="Weibo" href="https://weibo.com/1071696872" target="_blank" rel="noopener noreferrer nofollow"><i class="gi gi-weibo"></i></a></li></ul>
                        </nav>
                    </div>

                    <section id="prism__external_links">
                        <ul>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://github.com/AlanDecode/Maverick" rel="noopener noreferrer nofollow">Maverick</a>：🏄‍ Go My Own Way.
                                <span>|</span>
                            </li>
                            
                            <li>
                                <a class="no-link" target="_blank" href="https://www.imalan.cn" rel="noopener noreferrer nofollow">Triple NULL</a>：Home page for AlanDecode.
                                <span>|</span>
                            </li>
                            
                        </ul>
                    </section>

                    <div class="copyright">
                        <p class="copyright-text">
                            <span class="brand">walker's code blog</span>
                            <span>Copyright © 2022 AlanDecode</span>
                        </p>
                        <p class="copyright-text powered-by">
                            | Powered by <a href="https://github.com/AlanDecode/Maverick" class="no-link" target="_blank" rel="noopener noreferrer nofollow">Maverick</a> | Theme <a href="https://github.com/Reedo0910/Maverick-Theme-Prism" target="_blank" class="no-link" rel="noopener noreferrer nofollow">Prism</a>
                        </p>
                    </div>
                    <div class="footer-addon">
                        
                    </div>
                </section>
                <script>
                    var site_build_date = "2019-12-06T12:00+08:00"

                </script>
                <script src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/prism-efa8685153.js"></script>
            </footer>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/ExSearch/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/ExSearch/ExSearch-493cb9cd89.js"></script>

    <!--katex-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/katex.min.js"></script>
    <script>
        mathOpts = {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "\\[", right: "\\]", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false }
            ]
        };

    </script>
    <script defer src="https://cdn.jsdelivr.net/gh/wzywalker/wzywalker.github.io@main/assets/auto-render.min.js" onload="renderMathInElement(document.body, mathOpts);"></script>

    
</body>

</html>